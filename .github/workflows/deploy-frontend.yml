name: Deploy Taskify Frontend to AWS EC2  

on:
  push:
    branches:
      - main  # Se ejecuta cuando se haga un push a main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Clonar el repositorio
      uses: actions/checkout@v3

    - name: ğŸ³ Iniciar sesiÃ³n en DockerHub
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      run: |
        if [[ -z "$DOCKER_USERNAME" || -z "$DOCKER_PASSWORD" ]]; then
          echo "âŒ ERROR: DOCKERHUB_USERNAME o DOCKERHUB_PASSWORD no estÃ¡n configurados."
          exit 1
        fi
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

    - name: ğŸ› ï¸ Construir la imagen Docker
      run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/taskify-frontend .

    - name: ğŸ“¤ Subir la imagen a DockerHub
      run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/taskify-frontend

    - name: ğŸš€ Conectar a EC2, instalar dependencias y actualizar el contenedor
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.AWS_EC2_HOST }}
        username: ${{ secrets.AWS_EC2_USER }}
        key: ${{ secrets.AWS_PRIVATE_KEY }}
        port: 22
        script: |
          echo "âœ… Conectado a EC2"
          
          # Instalar Docker si no estÃ¡ instalado
          if ! command -v docker &> /dev/null
          then
            echo "ğŸ³ Instalando Docker..."
            sudo yum update -y
            sudo yum install -y docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -aG docker $USER
          fi

          # Limpiar imÃ¡genes antiguas
          echo "ğŸ§¹ Limpiando imÃ¡genes antiguas..."
          docker stop taskify-frontend || true
          docker rm taskify-frontend || true
          docker system prune -af || true

          # Descargar la Ãºltima imagen
          echo "ğŸ“¥ Descargando la Ãºltima imagen de DockerHub..."
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/taskify-frontend

          # Ejecutar el contenedor
          echo "ğŸš€ Ejecutando Taskify Frontend..."
          docker run -d -p 80:80 --name taskify-frontend ${{ secrets.DOCKERHUB_USERNAME }}/taskify-frontend

          # Verificar si el contenedor estÃ¡ corriendo
          docker ps | grep taskify-frontend || (echo "âŒ ERROR: El contenedor no se iniciÃ³ correctamente." && exit 1)

          echo "âœ… Despliegue completado exitosamente."
